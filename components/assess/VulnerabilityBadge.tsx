'use client'

import { cn } from '@/lib/utils'
import type { RiskLevel, VulnerabilityDimensions } from '@/types/schema'

interface VulnerabilityBadgeProps {
  riskLevel: RiskLevel
  dimensions?: VulnerabilityDimensions
  showDetails?: boolean
  className?: string
}

interface VulnerabilityDetailProps {
  audit: {
    risk_level: RiskLevel
    dimensions?: VulnerabilityDimensions
    rationale?: string
    dimension_explanations?: Record<string, string>
    strengths?: string[]
    vulnerabilities?: string[]
  }
}

// Dimension display info
const DIMENSIONS: {
  key: keyof VulnerabilityDimensions
  label: string
  description: string
  icon: string
}[] = [
  {
    key: 'reproducibility',
    label: 'Reproducibility',
    description: 'Could AI generate a plausible response?',
    icon: 'üîÑ',
  },
  {
    key: 'verification',
    label: 'Verification',
    description: 'Can you verify the student did the work?',
    icon: '‚úì',
  },
  {
    key: 'uniqueness',
    label: 'Uniqueness',
    description: 'Does it require student-specific input?',
    icon: 'üë§',
  },
  {
    key: 'temporal',
    label: 'Temporal',
    description: 'Are time constraints effective?',
    icon: '‚è±',
  },
  {
    key: 'embodied',
    label: 'Embodied',
    description: 'Does it require physical presence?',
    icon: 'üèÉ',
  },
]

// Risk level colors
const RISK_COLORS: Record<RiskLevel, { bg: string; text: string; border: string; dot: string }> = {
  low: { bg: 'bg-green-50', text: 'text-green-700', border: 'border-green-200', dot: 'bg-green-500' },
  medium: { bg: 'bg-amber-50', text: 'text-amber-700', border: 'border-amber-200', dot: 'bg-amber-500' },
  high: { bg: 'bg-red-50', text: 'text-red-700', border: 'border-red-200', dot: 'bg-red-500' },
}

export function VulnerabilityBadge({
  riskLevel,
  dimensions,
  showDetails,
  className,
}: VulnerabilityBadgeProps) {
  const colors = RISK_COLORS[riskLevel]

  return (
    <div className={cn('space-y-3', className)}>
      {/* Main Badge */}
      <div className={cn('inline-flex items-center gap-2 px-3 py-1.5 rounded-full border', colors.bg, colors.border)}>
        <span className={cn('w-2 h-2 rounded-full', colors.dot)} />
        <span className={cn('text-sm font-medium capitalize', colors.text)}>
          {riskLevel} AI Risk
        </span>
      </div>

      {/* Dimension Indicators */}
      {showDetails && dimensions && (
        <div className="flex flex-wrap gap-2">
          {DIMENSIONS.map(({ key, label }) => {
            const level = dimensions[key]
            if (!level) return null
            const dimColors = RISK_COLORS[level]
            return (
              <div
                key={key}
                className={cn(
                  'flex items-center gap-1.5 px-2 py-1 rounded text-xs',
                  dimColors.bg,
                  dimColors.text
                )}
              >
                <span className={cn('w-1.5 h-1.5 rounded-full', dimColors.dot)} />
                <span>{label}</span>
              </div>
            )
          })}
        </div>
      )}
    </div>
  )
}

export function VulnerabilityDetail({ audit }: VulnerabilityDetailProps) {
  const colors = RISK_COLORS[audit.risk_level]

  return (
    <div className="space-y-4">
      {/* Overall Risk */}
      <div className={cn('p-4 rounded-lg border', colors.bg, colors.border)}>
        <div className="flex items-center gap-2 mb-2">
          <span className={cn('w-3 h-3 rounded-full', colors.dot)} />
          <span className={cn('text-lg font-semibold capitalize', colors.text)}>
            {audit.risk_level} AI Vulnerability
          </span>
        </div>
        {audit.rationale && (
          <p className="text-sm text-gray-700">{audit.rationale}</p>
        )}
      </div>

      {/* Dimension Breakdown */}
      {audit.dimensions && (
        <div>
          <h4 className="text-sm font-medium text-gray-700 mb-3">Dimension Analysis</h4>
          <div className="space-y-2">
            {DIMENSIONS.map(({ key, label, description }) => {
              const level = audit.dimensions?.[key]
              if (!level) return null
              const dimColors = RISK_COLORS[level]
              const explanation = audit.dimension_explanations?.[key]

              return (
                <div
                  key={key}
                  className={cn('p-3 rounded-lg border', dimColors.bg, dimColors.border)}
                >
                  <div className="flex items-center justify-between mb-1">
                    <div className="flex items-center gap-2">
                      <span className={cn('w-2 h-2 rounded-full', dimColors.dot)} />
                      <span className="font-medium text-sm">{label}</span>
                    </div>
                    <span className={cn('text-xs font-medium uppercase', dimColors.text)}>
                      {level}
                    </span>
                  </div>
                  <p className="text-xs text-gray-500 mb-1">{description}</p>
                  {explanation && (
                    <p className="text-sm text-gray-700">{explanation}</p>
                  )}
                </div>
              )
            })}
          </div>
        </div>
      )}

      {/* Strengths & Vulnerabilities */}
      <div className="grid grid-cols-2 gap-4">
        {audit.strengths && audit.strengths.length > 0 && (
          <div>
            <h4 className="text-sm font-medium text-green-700 mb-2 flex items-center gap-1">
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Strengths
            </h4>
            <ul className="space-y-1">
              {audit.strengths.map((strength, i) => (
                <li key={i} className="text-sm text-gray-600 flex items-start gap-2">
                  <span className="text-green-500 mt-0.5">‚Ä¢</span>
                  {strength}
                </li>
              ))}
            </ul>
          </div>
        )}
        {audit.vulnerabilities && audit.vulnerabilities.length > 0 && (
          <div>
            <h4 className="text-sm font-medium text-red-700 mb-2 flex items-center gap-1">
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              Vulnerabilities
            </h4>
            <ul className="space-y-1">
              {audit.vulnerabilities.map((vuln, i) => (
                <li key={i} className="text-sm text-gray-600 flex items-start gap-2">
                  <span className="text-red-500 mt-0.5">‚Ä¢</span>
                  {vuln}
                </li>
              ))}
            </ul>
          </div>
        )}
      </div>
    </div>
  )
}
